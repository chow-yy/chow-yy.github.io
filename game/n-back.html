<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N-back Brain Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #game-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #grid-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
  }

  #grid {
    display: grid;
    gap: 5px;
  }

  .cell {
    width: 50px;
    height: 50px;
    background-color: lightgray;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    border-radius: 5px;
    user-select: none;
    transition: background-color 0.3s;
  }

  .active {
    background-color: blue;
    color: white;
  }

  .matched {
    background-color: green !important;
    color: white;
  }

  button {
    margin-top: 20px;
    font-size: 16px;
    padding: 10px 20px;
  }

  #instruction {
    position: absolute;
    top: 0;
    right: 0;
    max-width: 250px;
    background-color: #f0f0f0;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
  }

  label {
    margin: 0 10px;
  }
</style>
</head>
<body>

<h1>N-back Brain Training</h1>

<div id="game-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
    <div id="instruction" style="max-width: 250px; background:#f0f0f0; padding:10px; border-radius:5px;">
        Watch the sequence of blue squares.<br>
        Click <strong>Match</strong> if it matches the one <span id="nDisplay">N</span> steps back.<br>
        Find 5 matches to finish.
    </div>

    <div style="display:flex; flex-direction:column; align-items:center;">
        <div>
            <label>Grid size (L): <input type="number" id="gridSize" value="3" min="2" max="6"></label>
            <label>N-back (N): <input type="number" id="nBack" value="2" min="1"></label>
            <button onclick="startGame()">Start Game</button>
        </div>

        <div>
            <label>Speed (ms): <span id="speedDisplay">1500</span></label>
            <input type="range" id="speedSlider" min="500" max="3000" step="100" value="1500" oninput="updateSpeed(this.value)">
        </div>

        <div id="grid-container">
            <div id="grid"></div>
        </div>

        <button id="matchBtn" disabled onclick="matchClicked()">Match</button>
        <h2 id="result"></h2>
    </div>
</div>

<script>
let DISPLAY_INTERVAL = 1500;
let TOTAL_MATCHES = 5;

let L, N;
let sequence = [];
let matchPositions = [];
let currentIndex = 0;
let userMatches = [];
let interval;

function updateSpeed(value) {
    DISPLAY_INTERVAL = parseInt(value);
    document.getElementById('speedDisplay').textContent = DISPLAY_INTERVAL;

    if(interval) {
        clearInterval(interval);
        interval = setInterval(showNext, DISPLAY_INTERVAL);
    }
}

function startGame() {
    L = parseInt(document.getElementById('gridSize').value);
    N = parseInt(document.getElementById('nBack').value);

    generateSequence();
    createGrid();
    currentIndex = 0;
    userMatches = [];
    document.getElementById('result').textContent = '';
    document.getElementById('matchBtn').disabled = false;

    interval = setInterval(showNext, DISPLAY_INTERVAL);
}

function generateSequence() {
    sequence = [];
    matchPositions = [];
    let count = 0;

    while(count < TOTAL_MATCHES) {
        let rand = Math.floor(Math.random() * (L*L));
        sequence.push(rand);

        if(sequence.length > N && sequence[sequence.length-1] === sequence[sequence.length-N-1]) {
            count++;
            matchPositions.push(sequence.length-1);
        }
    }

    // Limit sequence length
    const maxLength = TOTAL_MATCHES * N * 5;
    while(sequence.length > maxLength) {
        // Remove a random element outside match sequences
        let removable = [];
        for(let i=0; i<sequence.length; i++) {
            if(!matchPositions.includes(i) && (i < N || i > sequence.length-N)) removable.push(i);
        }
        if(removable.length === 0) break;
        let removeIndex = removable[Math.floor(Math.random()*removable.length)];
        sequence.splice(removeIndex,1);

        // Update match positions
        matchPositions = matchPositions.map(p => p > removeIndex ? p-1 : p);
    }

    console.log("Sequence:", sequence);
    console.log("Match positions:", matchPositions);
}

function createGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    grid.style.gridTemplateColumns = `repeat(${L}, 50px)`;
    grid.style.gridTemplateRows = `repeat(${L}, 50px)`;

    for(let i = 0; i < L*L; i++) {
        let cell = document.createElement('div');
        cell.className = 'cell';
        cell.id = 'cell-' + i;
        cell.textContent = i;
        grid.appendChild(cell);
    }
}

function showNext() {
    if(currentIndex > 0) {
        document.getElementById('cell-' + sequence[currentIndex-1]).classList.remove('active');
    }

    if(currentIndex >= sequence.length) {
        clearInterval(interval);
        interval = null;
        document.getElementById('matchBtn').disabled = true;
        calculateAccuracy();
        return;
    }

    document.getElementById('cell-' + sequence[currentIndex]).classList.add('active');
    currentIndex++;
}

function matchClicked() {
    userMatches.push(currentIndex-1);
}

function calculateAccuracy() {
    let correctClicks = 0;

    // Count correct clicks only if it matches an actual N-back position
    for(let pos of userMatches) {
        if(matchPositions.includes(pos)) correctClicks++;
    }

    // Count missed matches
    let missed = matchPositions.filter(p => !userMatches.includes(p)).length;

    // Count false positives
    let falsePositives = userMatches.filter(p => !matchPositions.includes(p)).length;

    // Accuracy = correct / total clicks
    let accuracy = userMatches.length > 0 ? (correctClicks / userMatches.length) * 100 : 0;

    document.getElementById('result').textContent =
        `Correct clicks: ${correctClicks}, Missed: ${missed}, Wrong clicks: ${falsePositives}, Accuracy: ${accuracy.toFixed(2)}%`;

    // Highlight actual matched positions
    matchPositions.forEach(pos => {
        const cell = document.getElementById('cell-' + sequence[pos]);
        cell.classList.add('matched');
    });

    setTimeout(() => {
        matchPositions.forEach(pos => {
            const cell = document.getElementById('cell-' + sequence[pos]);
            cell.classList.remove('matched');
        });
    }, 2000);
}

</script>

</body>
</html>
